/*

************************************************************
**
** Created by: CodeBench 0.23 (17.09.2011)
**
** Project: libgen
**
** File:
**
** Date: 02-10-2014 22:43:42
**
************************************************************

*/

#include <proto/dos.h>
#include <proto/exec.h>


#include "makefile_utils.h"
#include "function_definition.h"
#include "utils.h"



#ifdef _DEBUG
#define MAKEFILE_UTILS_DEBUG (1)
#endif

/*
BOOL WriteMakefileHeader (BPTR makefile_p, CONST_STRPTR library_s)
{
	BOOL success_flag = FALSE;

	if (IDOS->FPrintf (makefile_p, "# Use our generated source rather than the stub files created by idltool\n\n%s_SRCS = \\\n", library_s) >= 0)
		{
			success_flag = TRUE;
		}

	return success_flag;
}


BOOL WriteMakefileFooter (BPTR makefile_p)
{
	BOOL success_flag = FALSE;

	if (IDOS->FPrintf (makefile_p, "\n\ninclude Makefile\n") >= 0)
		{
			success_flag = TRUE;
		}

	return success_flag;
}
*/

BOOL AddFileToMakefileSources (BPTR makefile_p, CONST_STRPTR filename_s)
{
	BOOL success_flag = TRUE;

	if (makefile_p)
		{
			if (IDOS->FPrintf (makefile_p, "\t%s \\\n", filename_s) < 0)
				{
					IDOS->Printf ("Error writing %s to list of sources in makefile\n", filename_s);
					success_flag = FALSE;
				}
		}
	else
		{
			IDOS->Printf ("makefile handle is null");
		}

	return success_flag;
}


BOOL CloseMakefile (BPTR makefile_p)
{
	return (IDOS->FClose (makefile_p) != 0);
}


BPTR GetMakefileHandle (CONST_STRPTR library_s)
{
	BPTR makefile_p = ZERO;
	STRPTR makefile_s = ConcatenateStrings (library_s, ".mk");

	if (makefile_s)
		{
			makefile_p = IDOS->FOpen (makefile_s, MODE_NEWFILE, 0);

			if (makefile_p)
				{
					if (!WriteMakefileHeader (makefile_p, library_s))
						{
							IDOS->Printf ("Failed to write header block to makefile \"%s\"\n", makefile_s);
						}
				}
			else
				{
					IDOS->Printf ("Failed to open makefile \"%s\"\n", makefile_s);
				}

			IExec->FreeVec (makefile_s);
		}
	else
		{
			IDOS->Printf ("Failed to create makefile name for \"%s\"\n", library_s);
		}

	return makefile_p;
}



BOOL WriteVectorsFile (CONST_STRPTR library_s, struct List *  const function_defs_p)
{
	BOOL success_flag = FALSE;
	STRPTR file_s = ConcatenateStrings (library_s, "_vectors.h");

	if (file_s)
		{
			BPTR out_p = IDOS->FOpen (file_s, MODE_NEWFILE, 0);

			if (out_p)
				{
					CONST_STRPTR header_s =
						"/* This file was generated by libgen */\n\n"
						"#include <exec/types.h>\n"
						"#include <exec/exec.h>\n"
						"#include <exec/interfaces.h>\n\n";

					if (IDOS->FPrintf (out_p, "%s", header_s) >= 0)
						{
							struct FunctionDefinitionNode *node_p = (struct FunctionDefinitionNode *) IExec->GetHead (function_defs_p);
							BOOL loop_flag = TRUE;

							while (node_p && loop_flag)
								{
									if (WriteFunctionDefinitionDeclaration (node_p -> fdn_function_def_p, out_p))
										{
											node_p = (struct FunctionDefinitionNode *) IExec->GetSucc (& (node_p -> fdn_node));
										}
									else
										{
											loop_flag = FALSE;
										}
								}		/* while (node_p && loop_flag) */

							if (!node_p)
								{
									if (IDOS->FPrintf (out_p, "\n\nSTATIC CONST APTR %s_vectors [] = \n{\n\t%s_Obtain,\n%s_Release,\nNULL,\nNULL,\n", library_s, library_s, library_s) >= 0)
										{
											node_p = (struct FunctionDefinitionNode *) IExec->GetHead (function_defs_p);
											loop_flag = TRUE;

											while (node_p && loop_flag)
												{
													if (IDOS->FPrintf (out_p, "\t_%s_%s,\n", library_s, node_p -> fdn_function_def_p -> fd_definition_p -> pa_name_s) >= 0)
														{
															node_p = (struct FunctionDefinitionNode *) IExec->GetSucc (& (node_p -> fdn_node));
														}
													else
														{
															loop_flag = FALSE;
														}
												}		/* while (node_p && loop_flag) */

											if (!node_p)
												{
													if (IDOS->FPrintf (out_p, "\t(APTR) -1\n};\n") >= 0)
														{
															success_flag = TRUE;
														}
												}

										}		/* if (IDOS->FPrintf (makefile_p, "\n\nSTATIC CONST APTR %s_vectors [] = \n{\n", library_s) >= 0) */

								}		/* if (!loop_flag) */

						}		/* if (IDOS->FPrintf (out_p, header_s) >= 0) */


					IDOS->FClose (out_p);
				}
			else
				{
					IDOS->Printf ("Failed to open \"%s\"\n", file_s);
				}

			IExec->FreeVec (file_s);
		}
	else
		{
			IDOS->Printf ("Failed to create vectors file name for \"%s\"\n", library_s);
		}

	return success_flag;
}




BOOL WriteAutoInitFile (CONST_STRPTR library_s)
{
	BOOL success_flag = FALSE;
	STRPTR file_s = ConcatenateStrings (library_s, "_auto_init.c");

	if (file_s)
		{
			BPTR out_p = IDOS->FOpen (file_s, MODE_NEWFILE, 0);

			if (out_p)
				{
					CONST_STRPTR header_s =
						"/* This file was generated by libgen and is based upon Hyperion's IDLTool code generation*/\n\n"
						"#include <interfaces/test.h>\n"
						"#include <proto/exec.h>\n"
						"#include <assert.h>\n\n"
						"/******************************************/\n";

					if (IDOS->FPrintf (out_p, "%s", header_s) >= 0)
						{
							if (IDOS->FPrintf (out_p, "struct Library *%sBase = NULL;\nstatic struct Library *__%s\n\n", library_s, library_s) >= 0)
								{
									if (IDOS->FPrintf (out_p,
										"void %sConstructor (void)\n{\tif (%sBase != NULL)\n\t\t{\n\t\t\treturn; /* Someone was quicker, e.g. an interface constructor */\n\t\t}\n = NULL;\n ", library_s, library_s) >= 0)
										{
											
										}



								}		/* if (IDOS->FPrintf (out_p, header_s) >= 0) */

						}		/* if (IDOS->FPrintf (out_p, header_s) >= 0) */

					IDOS->FClose (out_p);
				}
			else
				{
					IDOS->Printf ("Failed to open \"%s\"\n", file_s);
				}

			IExec->FreeVec (file_s);
		}
	else
		{
			IDOS->Printf ("Failed to create vectors file name for \"%s\"\n", library_s);
		}

	return success_flag;
}
