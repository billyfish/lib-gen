#include <proto/dos.h>
#include <proto/exec.h>

#include "debugging_utils.h"
#include "utils.h"


static BOOL WriteTop (BPTR out_p, CONST CONST_STRPTR library_s);


BOOL WriteInitFile (CONST_STRPTR library_s, CONST_STRPTR out_dir_s)
{
	BOOL success_flag = FALSE;
	STRPTR full_path_s = NULL;

	ENTER ();


	full_path_s = MakeFilename (out_dir_s, "init.c");
	
	if (full_path_s)
		{
			BPTR out_p = IDOS->FOpen (full_path_s, MODE_NEWFILE, 0);
			
			if (out_p)
				{
					if (WriteTop (out_p, library_s))
						{
							success_flag = TRUE;
						}
						
					if (IDOS->FClose (out_p) == 0)
						{
							
						}
				}
			
			IExec->FreeVec (full_path_s);
		}

	LEAVE ();
	return success_flag;
}


/* ------------------- Library Interface(s) ------------------------ */


static BOOL WriteTop (BPTR out_p, CONST CONST_STRPTR library_s)
{
	BOOL success_flag = FALSE;

	ENTER ();
	
	if (IDOS->FPrintf (out_p, "/*\n** This file was generated by LibGen and is based upon the\n** output from idltool.\n*/\n\n") >= 0)
		{
			if (IDOS->FPrintf (out_p, 
				"#include <proto/exec.h>\n\n"   
				"#include \"vectors.h\"\n\n"
				"#include \"lib_init.h\"\n\n"
				"/* Uncomment this line (and see below) if your library has a 68k jump table */\n"
				"/* extern APTR VecTable68K []; */\n\n"
				"STATIC CONST struct TagItem %sTags [] =\n"
				"{\n"
				"\t{ MIT_Name, (Tag) \"%s\" },\n"
				"\t{ MIT_VectorTable,	(Tag) %s_vectors },\n"
				"\t{ MIT_Version,	1	},\n"
				"\t{ TAG_DONE, 0 }\n"
				"};\n\n", library_s, library_s, library_s) >= 0)
				{
					if (IDOS->FPrintf (out_p, 
						"STATIC CONST CONST_APTR libInterfaces [] =\n"
						"{\n"
						"\tlib_managerTags,\n"
						"\t%sTags,\n"
						"\tNULL\n"
						"};\n\n", library_s) >= 0)
						{
							if (IDOS->FPrintf (out_p,
								"STATIC CONST struct TagItem libCreateTags [] =\n"
								"{\n"
								"\t{ CLT_DataSize,		sizeof (struct Library)	},\n"
								"\t{ CLT_InitFunc,		(Tag) libInit },\n"
								"\t{ CLT_Interfaces,	(Tag) libInterfaces },\n\n"
								"\t/* Uncomment the following line if you have a 68k jump table */\n"
								"\t/* { CLT_Vector68K, (Tag) VecTable68K }, */\n\n"
								"\t{TAG_DONE, 0 }\n"
								"};\n\n") >= 0)       
								{
									if (IDOS->FPrintf (out_p, 
										"\n/* ------------------- ROM Tag ------------------------ */\n"
										"STATIC CONST struct Resident lib_res USED =\n"
										"{\n"
										"\tRTC_MATCHWORD,\n"
										"\t(struct Resident *) &lib_res,\n"
										"\t(APTR) (&lib_res + 1),\n"
										"\tRTF_NATIVE | RTF_AUTOINIT, /* Add RTF_COLDSTART if you want to be resident */\n"
										"\tVERSION,\n"
										"\tNT_LIBRARY, /* Make this NT_DEVICE if needed */\n"
										"\t0, /* PRI, usually not needed unless you're resident */\n"
										"\t\"\",\n"
										"\tVSTRING,\n"
										"\t(APTR) libCreateTags\n"
										"};\n\n") >= 0)
										{
											if (IDOS->FPrintf (out_p,
												"uint32 t_Obtain (struct %sIFace *Self)\n"
												"{\n"
												"\t/* Write me. Really, I dare you! */\n"
												"\t((struct ExecIFace *) ((*(struct ExecBase **) 4)->MainInterface))->DebugPrintF (\"Function test::Obtain not implemented\");\n"
												"\n\treturn (uint32) 0;\n"
												"}\n\n"
												"uint32 t_Release (struct %sIFace *Self)\n"
												"{\n"
												"\t/* Write me. Really, I dare you! */\n"
												"\t((struct ExecIFace *) ((*(struct ExecBase **) 4)->MainInterface))->DebugPrintF (\"Function test::Release not implemented\");\n"
												"\treturn (uint32) 0;\n"
												"}\n\n", library_s, library_s) >= 0)            
											{	
												success_flag = TRUE;
											}
										}
                }     
						}
				}
		}

	LEAVE ();
	
	return success_flag;
}
        

